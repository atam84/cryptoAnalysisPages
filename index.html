<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crypto Signals ‚Äî GitHub Pages Template</title>
  <meta name="description" content="Static viewer for bot signals (Trend, levels, trade plan). Drop this on GitHub Pages and feed it JSON from n8n." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f14; /* deep slate */
      --panel: #121821; /* card */
      --text: #e6eef7;
      --muted: #9fb1c7;
      --accent: #7dd3fc; /* cyan */
      --up: #22c55e;
      --down: #ef4444;
      --warn: #eab308;
      --res: #f97316; /* orange */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ring: 0 0 0 2px rgba(125,211,252,.3);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 100% -10%, #0f172a 0%, #0b0f14 40%, #0b0f14 100%);
      color:var(--text); line-height:1.45;
    }
    .wrap{max-width:1100px; margin:40px auto; padding:0 20px}
    header{display:flex; align-items:center; gap:14px; justify-content:space-between; margin-bottom:22px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:38px; height:38px; border-radius:12px; background:linear-gradient(180deg,#22c55e 0%, #0ea5e9 100%); box-shadow:var(--shadow)}
    h1{font-size:20px; margin:0}
    .subtitle{color:var(--muted); font-size:13px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap}
    .pill{background:rgba(125,211,252,.12); border:1px solid rgba(125,211,252,.28); color:#dbeafe; padding:8px 12px; border-radius:12px; font-size:12px}
    .btn{cursor:pointer; background:#0b1220; border:1px solid #1f2a3a; color:var(--text); padding:10px 14px; border-radius:12px; font-size:13px; transition:.18s ease; box-shadow:var(--shadow)}
    .btn:hover{transform:translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.45)}

    .grid{display:grid; grid-template-columns: repeat(12, 1fr); gap:16px; margin-top:18px}
    .card{grid-column: span 12; background:linear-gradient(180deg, rgba(18,24,33,.9), rgba(12,17,24,.9)); border:1px solid #1f2a3a; border-radius:18px; box-shadow:var(--shadow); padding:18px}
    @media(min-width:860px){.card{grid-column: span 6}}

    .symbol{display:flex; align-items:center; gap:10px; margin-bottom:6px}
    .symbol .tag{font-weight:700; font-size:14px; letter-spacing:.2px}
    .status{display:inline-flex; align-items:center; gap:8px; background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.3); color:#bbf7d0; padding:6px 10px; border-radius:999px; font-size:12px}
    .muted{color:var(--muted)}
    .kvs{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; margin-top:12px}
    .kv{padding:10px 12px; border:1px dashed #213148; border-radius:14px; font-size:13px; background:rgba(13,20,31,.55)}
    .kv strong{font-family:var(--mono)}
    .levels{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .chip{font-size:12px; padding:8px 10px; border-radius:10px; background:#0c1422; border:1px solid #223147}
    .chip.up{border-color:rgba(34,197,94,.4); color:#bbf7d0}
    .chip.down{border-color:rgba(239,68,68,.4); color:#fecaca}
    .chip.warn{border-color:rgba(234,179,8,.45); color:#fde68a}
    .chip.res{border-color:rgba(249,115,22,.45); color:#fed7aa}

    .plan{margin-top:12px; padding:12px; border-radius:14px; background:linear-gradient(180deg, rgba(7,13,22,.7), rgba(10,15,23,.7)); border:1px solid #223349}
    .plan h4{margin:0 0 8px 0; font-size:14px}
    .plan ul{margin:6px 0 0 18px; padding:0; font-size:13px}

    .foot{margin-top:16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
    .time{font-size:12px; color:var(--muted)}

    .empty{opacity:.7; border-style:dashed}

    .notice{margin-top:20px; font-size:12px; color:#9fb1c7}
    code.inline{background:#0b1220; padding:.2rem .4rem; border-radius:6px; border:1px solid #223147}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Crypto Signals</h1>
          <div class="subtitle">Static viewer for Telegram-style bot messages</div>
        </div>
      </div>
      <div class="toolbar">
        <span class="pill" id="count-pill">0 Signals</span>
        <button class="btn" id="refresh">Refresh</button>
      </div>
    </header>

    <div id="grid" class="grid" role="list"></div>

    <p class="notice">
      Feed this page with data by replacing <code class="inline">__DATA__</code> at build time from n8n, or by serving a <code class="inline">data.json</code> next to this file. See instructions at the bottom of the source.
    </p>
  </div>

  <script>
    /*
      ========= How data is supplied =========
      1) Easiest: n8n writes index.html and replaces the token __DATA__ with a JSON string.
         Example Function node: set item.binary to string, then .replace('__DATA__', JSON.stringify(yourArray)) before committing.
      2) Or, host a data.json in the same repo and this page will fetch it.

      Schema expected: flexible. Supported inputs include:
      - An array of objects where each object has a `result` **object** with `text` (old format)
      - An array of objects where each object has a `result` **array** of messages (new format you posted)
      - An array of message objects directly (fallback)
      We'll recursively scan for messages and render cards from any of those shapes.
    */

    // üëá This constant will be replaced via n8n template replacement.
    const EMBEDDED_DATA = __DATA__; // Leave as-is for template; replace with JSON string like [...]

    async function getData(){
      try{
        if(Array.isArray(EMBEDDED_DATA)) return EMBEDDED_DATA;
      }catch(e){ /* token not replaced, fallthrough */ }
      // If no embedded data, try fetch data.json
      try{
        const res = await fetch('data.json', {cache:'no-store'});
        if(res.ok){ return await res.json(); }
      }catch(e){ /* ignore */ }
      return [];
    }

    // Robust text parser for the provided format
    function parseMessage(text){
      if(!text || typeof text !== 'string') return null;
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = { raw:text };

      // Trend
      const t = lines.find(l=>/^trend\s*:/i.test(l));
      if(t){ out.trend = t.split(':')[1]?.trim().toLowerCase(); }

      // Approaching support/resistance
      const supL = lines.find(l=>/approaching support/i.test(l));
      if(supL){
        const m = supL.match(/support\s*\(([^)]+)\)/i); if(m) out.approachingSupport = m[1];
      }
      const resL = lines.find(l=>/approaching resistance/i.test(l));
      if(resL){
        const m = resL.match(/resistance\s*\(([^)]+)\)/i); if(m) out.approachingResistance = m[1];
      }

      // Last 1h candle block
      const open = text.match(/Open\s*:\s*([\d.]+)/i); if(open) out.open = parseFloat(open[1]);
      const close = text.match(/Close\s*:\s*([\d.]+)/i); if(close) out.close = parseFloat(close[1]);
      const high = text.match(/High\s*:\s*([\d.]+)/i); if(high) out.high = parseFloat(high[1]);
      const low  = text.match(/Low\s*:\s*([\d.]+)/i);  if(low)  out.low  = parseFloat(low[1]);
      const amp  = text.match(/Amplitude\s*H\/L\s*:\s*([\d.]+)\s*(\w+)?/i); if(amp) out.amplitude = amp[1] + (amp[2] ? ' '+amp[2] : '');

      // 48h analysis, levels
      const ath = text.match(/ATH\s*:\s*([\d.]+)/i); if(ath) out.ath = parseFloat(ath[1]);
      const atl = text.match(/ATL\s*:\s*([\d.]+)/i); if(atl) out.atl = parseFloat(atl[1]);
      const sup = text.match(/Support\s*:\s*([\d.]+)/i); if(sup) out.support = parseFloat(sup[1]);
      const res = text.match(/R[√©e]sistance\s*:\s*([\d.]+)/i); if(res) out.resistance = parseFloat(res[1]);

      // Symbol line like: - üü¢ [SOL/USDT]
      const sym = text.match(/\[([A-Z0-9]+\/[A-Z0-9]+)\]/);
      if(sym) out.symbol = sym[1];

      // Trade plan
      const buy = text.match(/Achat\s+entre\s*\[([^\]]+)\]/i);
      if(buy){ out.buyZone = buy[1].replace(/\$/g,'').trim(); }
      const target = text.match(/Target\s*\[([^\]]+)\]/i);
      if(target){ out.targets = target[1].replace(/\$/g,'').trim(); }
      const stop = text.match(/Stop\s*loss\s*[a√†]\s*([\d.]+)/i);
      if(stop){ out.stopLoss = parseFloat(stop[1]); }
      const minW = text.match(/Target\s*min\s*win\s*([\d.]+)%/i);
      if(minW){ out.minWin = parseFloat(minW[1]); }

      // Commentary arrow block
      const commentIdx = lines.findIndex(l=>l.startsWith('‚Üí'));
      if(commentIdx>=0){ out.comment = lines.slice(commentIdx).join(' '); }

      // Derived
      if(Number.isFinite(out.open) && Number.isFinite(out.close)){
        const ch = out.close - out.open;
        out.change = ch;
        out.changePct = out.open !== 0 ? (ch/out.open)*100 : 0;
      }
      return out;
    }

    function fmt(n){ if(n===undefined || n===null || Number.isNaN(n)) return '‚Äî'; const s = Number(n); return Number.isFinite(s) ? s.toLocaleString(undefined,{maximumFractionDigits:4}) : n; }

    function trendBadge(trend){
      trend = (trend||'').toLowerCase();
      if(trend.includes('bull')) return '<span class="status" title="Trend"><span>üêÇ</span><b>Bullish</b></span>';
      if(trend.includes('bear')) return '<span class="status" style="background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.3);color:#fecaca" title="Trend"><span>üêª</span><b>Bearish</b></span>';
      return '<span class="status" style="background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35);color:#fde68a" title="Trend"><span>‚öñÔ∏è</span><b>Neutral</b></span>';
    }

    function cardTemplate(parsed, meta){
      const symbol = parsed.symbol || '‚Äî';
      const ch = parsed.change;
      const chStr = (ch===undefined) ? '' : (ch>=0? `+${fmt(ch)} (${fmt(parsed.changePct)}%)` : `${fmt(ch)} (${fmt(parsed.changePct)}%)`);
      const chClass = ch>=0? 'up' : 'down';

      return `
        <article class="card ${!parsed.symbol?'empty':''}" role="listitem" aria-label="${symbol}">
          <div class="symbol">
            <div class="tag">${symbol}</div>
            <div>${trendBadge(parsed.trend)}</div>
            <div class="chip ${ch>=0?'up':'down'}" title="Change from last 1h open">${ch===undefined?'' : (ch>=0?'‚ñ≤ ':'‚ñº ')}${chStr}</div>
          </div>

          <div class="kvs">
            <div class="kv">Open: <strong>${fmt(parsed.open)}</strong></div>
            <div class="kv">Close: <strong>${fmt(parsed.close)}</strong></div>
            <div class="kv">High: <strong>${fmt(parsed.high)}</strong></div>
            <div class="kv">Low: <strong>${fmt(parsed.low)}</strong></div>
            <div class="kv">Amplitude H/L: <strong>${parsed.amplitude||'‚Äî'}</strong></div>
            <div class="kv">ATH 48h: <strong>${fmt(parsed.ath)}</strong></div>
          </div>

          <div class="levels">
            <div class="chip warn" title="Approaching support">üü° Support‚âà <b>${parsed.approachingSupport||'‚Äî'}</b></div>
            <div class="chip warn" title="Approaching resistance">üü° Resistance‚âà <b>${parsed.approachingResistance||'‚Äî'}</b></div>
            <div class="chip up" title="Support">üü† Support: <b>${fmt(parsed.support)}</b></div>
            <div class="chip res" title="Resistance">üõë R√©sistance: <b>${fmt(parsed.resistance)}</b></div>
          </div>

          <div class="plan">
            <h4>Trade plan</h4>
            <ul>
              <li><b>Buy zone:</b> ${parsed.buyZone || '‚Äî'}</li>
              <li><b>Targets:</b> ${parsed.targets || '‚Äî'}</li>
              <li><b>Stop-loss:</b> ${parsed.stopLoss!==undefined? fmt(parsed.stopLoss): '‚Äî'}</li>
              <li><b>Min. win:</b> ${parsed.minWin!==undefined? parsed.minWin+'%':'‚Äî'}</li>
            </ul>
          </div>

          <div class="foot">
            <div class="time">${meta?.when || ''}</div>
            <div class="muted">From: ${meta?.from || 'bot'} ¬∑ Chat: ${meta?.chat || ''}</div>
          </div>
        </article>
      `;
    }

    function asWhen(unixOrUndefined){
      if(!unixOrUndefined) return '';
      try{ const d = new Date(unixOrUndefined*1000); return d.toLocaleString(); }catch{ return '' }
    }

    function extractUpdates(arr){
      // Accepts multiple shapes and flattens into a list of message objects
      const messages = [];

      (function walk(node){
        if(!node) return;
        if(Array.isArray(node)){
          for(const el of node) walk(el);
          return;
        }
        if(typeof node === 'object'){
          // Direct message object
          if(node.text){ messages.push(node); return; }
          // Common wrappers
          if(node.result !== undefined){ walk(node.result); return; }
          if(node.message !== undefined){ walk(node.message); return; }
        }
      })(arr);

      const out = [];
      for(const m of messages){
        out.push({
          parsed: parseMessage(m.text),
          meta: {
            when: asWhen(m.date),
            ts: m.date || 0,
            chat: m.chat?.first_name || m.chat?.id,
            from: m.from?.username || m.from?.first_name || 'bot',
          }
        });
      }

      // Sort newest first if dates exist
      out.sort((a,b)=> (b.meta.ts||0) - (a.meta.ts||0));
      return out;
    }

    async function render(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '<div class="muted" style="grid-column: span 12">Loading‚Ä¶</div>';
      const data = await getData();
      const updates = extractUpdates(data);
      document.getElementById('count-pill').textContent = `${updates.length} Signal${updates.length!==1?'s':''}`;
      if(!updates.length){
        grid.innerHTML = '<div class="muted" style="grid-column: span 12">No signals found in data.</div>';
        return;
      }
      grid.innerHTML = updates.map(u=>cardTemplate(u.parsed, u.meta)).join('');
    }

    document.getElementById('refresh').addEventListener('click', render);
    render();
  </script>
</body>
</html>
